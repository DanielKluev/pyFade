# Changelog

## [Unreleased]

### Added
- **Completions Search Feature**: Implemented new navigation type for searching samples by completion content
  - Added "Completions Search" option to navigation sidebar combobox
  - Search through all completion texts across all samples in the dataset
  - Option to search only in top-rated completions via "Top Rated Only" toggle button
  - Shows placeholder message when no search query is entered
  - Displays "No completions found" message when search yields no results
  - Groups matching samples by their group_path in hierarchical tree structure
  - Case-insensitive search matching
  - Top-rated mode considers highest rating across all facets for each sample
  - **Performance Optimization**: Search button and Enter-key trigger instead of keystroke-by-keystroke
    - Search button visible only in Completions Search mode
    - Search triggers on button click or Enter key press (not on every character typed)
    - Other navigation modes still use instant search on keystroke
    - Optimized database query using SQL JOINs for regular search mode
    - Python filtering for top-rated mode ensures accurate rating comparison
    - Prevents UI freezing on large datasets (1500 samples × 10 completions)
  - Comprehensive test coverage with 16 unit tests covering all scenarios
  - All tests passing (564 UI tests, 80 navigation tests)
  - Pylint score: 10.00/10 for py_fade, 9.99/10 for tests
- **Alphabetical Sorting for Samples by Group**: Navigation panel now displays both samples and subgroups sorted lexicographically together
  - Samples in "Samples by Group" mode are now sorted case-insensitively by title
  - Subgroup nodes are also sorted alphabetically together with samples at each level
  - Added `_sort_tree_children_recursively()` method to recursively sort all children (samples + subgroups)
  - Optimized for performance by removing redundant sorting and using reverse-order removal
  - Comprehensive test coverage with 3 new unit tests (alphabetical sorting, case-insensitive sorting, mixed nodes sorting)
  - All tests passing (914 total, 4 skipped)
  - Pylint score: 10.00/10 for both py_fade and tests
- **Improved Export Template Edit**: Enhanced export template widget with scrollable area for better usability with many facets
  - Added QScrollArea to CrudFormWidget base class to wrap form content
  - Export template form now scrollable to accommodate extensive content
  - Facets table minimum height increased to 530px to comfortably display 10+ facets
  - Removed layout stretch that caused layout issues with many facets
  - Updated docstrings to reflect scrollable functionality
  - Comprehensive test coverage with 2 new unit tests (scrollable behavior, scroll area properties)
  - All tests passing (909 total, 4 skipped)
  - Pylint score: 10.00/10 for both py_fade and tests
- **Display Lowest Logprob Token**: Enhanced logprobs tooltip to show the token with the lowest logprob value
  - New `CommonCompletionLogprobs.get_min_logprob_token()` method finds and returns the token with minimum logprob
  - Tooltip in completion widget now displays min, avg, and lowest token with its value
  - Format: "Lowest token: 'token_str' (logprob_value)" shown on new line in tooltip
  - Comprehensive test coverage with 12 new unit tests (8 for get_min_logprob_token, 4 for tooltip display)
  - All tests passing (907 total, 4 skipped)
  - Pylint score: 10.00/10 for both py_fade and tests
- **Beam Search Window Prefill Improvements**: Enhanced prefill management in beam search window for easier workflow
  - Prefill history tracking: Maintains up to 50 unique prefill texts used in generation or token selection
  - History combobox: Easy selection and reuse of previous prefill texts with automatic deduplication
  - Increased prefill field height: Minimum height increased from 60px to 90px (2-3 more visible rows)
  - "Use as Prefill" button: New button on beam completion frames to copy completion text to prefill field
  - Auto-save to history: Prefill text is automatically saved to history when generating beams or using selective mode
  - Smart history management: Old prefill saved to history when using "Use as Prefill" button
  - Long text handling: Long prefill items are truncated to 100 characters in combobox display
  - Multiline support: Multiline prefills are displayed as single line in combobox (newlines replaced with spaces)
  - Comprehensive test coverage with 21 new unit tests covering all scenarios
  - All tests passing (888 total, 4 skipped)
  - Pylint score: 10.00/10 for changed files, 9.99/10 for py_fade, 9.97/10 for tests
- **Facet Switching**: Interactive facet management for samples with clickable facets and comprehensive switching operations
  - Clickable facets display in sample widget using new ClickableFacetsWidget component
  - Click any facet to open FacetSwitchDialog with Remove, Change, or Copy operations
  - Remove facet: Delete all ratings and pairwise rankings for that facet from the sample
  - Change facet: Transfer all ratings/rankings to another facet, removing from source
  - Copy facet: Duplicate all ratings/rankings to another facet, keeping source intact
  - Conflict handling: Never overwrites existing ratings in target facet
  - Visual feedback: Clickable facets with hover effects and active facet highlighting
  - Comprehensive test coverage with 22 new unit tests (7 controller, 8 dialog, 7 widget)
  - All tests passing (846 total, 4 skipped)
  - Pylint score: 10.00/10 for py_fade, 9.99/10 for tests
- **Clean Alternative Tokens On Archive**: Automatically clean alternative logprobs when archiving completions to save disk space
  - New `PromptCompletion.clean_alternative_logprobs()` method removes alternative token data from all associated logprobs entries
  - Archive button in completion widgets now automatically calls `clean_alternative_logprobs()` when archiving
  - Sampled logprobs are preserved when cleaning alternative logprobs
  - Archived completions are excluded from `DatasetDatabase.get_beams_for_prompt_and_model()` query
  - Generation controller cache no longer loads archived completions
  - Unarchiving a completion does not restore alternative logprobs (they are permanently removed)
  - Comprehensive test coverage with 8 new unit tests covering all scenarios
  - All tests passing (821 total, 4 skipped)
  - Pylint score: 10.00/10 for both py_fade and tests
- **Refactored Beam Search Window**: Improved beam search interface for better usability and visual consistency
  - Removed temperature and top_k UI controls; beam search now uses deterministic settings (temp=0.0, top_k=1)
  - Replaced standard buttons with icon buttons (QPushButtonWithIcon) with Material Design icons and tooltips
  - Generate button uses "beaming" icon, Selective uses "step" icon, Stop uses "close" icon
  - Window opens maximized by default for optimal viewing space
  - Implemented adaptive grid layout that adjusts number of columns based on window width (min 1, calculated from min_beam_width=400px)
  - Enhanced generation status to show "Generating X out of Y beams" excluding pinned completions
  - Completion message shows both new beams generated and total (including pinned)
  - Added resizeEvent handler for responsive grid layout
  - Comprehensive test coverage with 13 new unit tests (3 deterministic settings, 3 icon buttons, 4 progress status, 3 adaptive grid)
  - All tests passing (757 total, 4 skipped)
  - Pylint score: 10.00/10 for py_fade, 9.98/10 for tests
- **Sample Facets Display**: Show all facets that have ratings for a sample in the sample widget
  - New facets display row in WidgetSample right panel, positioned above tags row
  - Displays all facets with ratings for the current sample as comma-separated names
  - Active facet is highlighted with green background and bold text for easy identification
  - Automatically updates when active context (facet) changes
  - Shows appropriate messages for new samples ("No facets yet") and samples without ratings ("No facets")
  - New `Sample.get_facets(dataset)` method returns ordered list of facets with ratings
  - Comprehensive test coverage with 13 new unit tests (6 database, 7 UI)
  - All 744 tests passing (including new tests)
  - Pylint score: 10.00/10 for py_fade, 9.97/10 for tests
- **Complex Samples Filtering**: Implemented advanced filtering system for samples with multiple filter rules combined via AND logic
  - New `SampleFilter` database model for storing complex filter definitions with JSON-encoded rules
  - `FilterRule` data class supporting three rule types: String search, Tag presence, and Facet ratings
  - Each rule supports optional negation (NOT operator) to match samples that don't meet the criteria
  - `Sample.fetch_with_complex_filter()` method applies filter rules with AND logic across all samples
  - Added "Samples by Filter" option to navigation sidebar with filter selector dropdown
  - Filter selector auto-refreshes when dataset changes and supports flat/hierarchical group_path views
  - Comprehensive test coverage with 75 new unit tests (20 database, 33 logic, 13 complex application, 9 UI)
  - All tests passing (716 total, 4 skipped)
  - Pylint score: 10.00/10 for py_fade, 9.99/10 for tests
  - **Note**: Filter management UI (dialog for creating/editing filters) not yet implemented - filters can be created programmatically
- **Expandable Detachable Sample Notes**: Implemented feature for editing notes in a separate expanded window
  - New "Open in New" button in corner of notes field in WidgetSample
  - Detached notes window (DetachedNotesWindow) provides maximized editing space
  - Window is non-modal, allowing users to switch between completions and notes
  - Bi-directional synchronization between main widget and detached window
  - Save button in detached window to persist notes changes to database
  - Notes editor fills entire window space for comfortable editing
  - Changes automatically synced when closing detached window
  - Reopening existing window brings it to front instead of creating duplicate
  - Added open_in_new and open_in_full icons to Google Material Symbols icon map
  - Comprehensive test coverage with 31 new unit tests (19 for window, 12 for integration)
  - All tests passing (391 UI tests total)
  - Pylint score: 10.00/10 for both py_fade and tests
- **Flat List View Toggle for Tags and Facets**: Added compact toggle button to navigation panel for flat sample listing
  - New `QPushButtonToggle` reusable component with icon support and visual border feedback
  - Toggle button appears only when viewing "Samples by Tag" or "Samples by Facet" modes
  - Flat mode displays samples directly under tag/facet without group_path hierarchy
  - Hierarchical mode (default) maintains existing group_path-based tree structure
  - Preference persisted per-dataset in application config (nav_flat_list_mode)
  - Added view_list and account_tree icons to Google Material Symbols icon map
  - Comprehensive test coverage with 8 new unit tests (5 for toggle component, 3 for navigation)
  - All tests passing (588 total, 4 skipped)
  - Pylint score: 10.00/10 for both py_fade and tests
- **Model Manager Window**: Implemented GUI for managing LLM inference models
  - New Preferences menu with "Manage Models..." action accessible from dataset window
  - Three-tab interface for different model types: llama.cpp, Ollama, and Remote API (placeholder)
  - llama.cpp tab supports GGUF file paths with optional LoRA adapters
  - Ollama tab supports manual model entry and automatic import from local Ollama registry
  - Full CRUD operations: Add, Edit, Remove models with form validation
  - Browse buttons for file selection
  - Model configuration validation (unique IDs, required backends)
  - Save changes to application config YAML file
  - Dynamic provider reload and GUI updates on save
  - Comprehensive test coverage with 18 new unit tests
  - All tests passing (578 total, 4 skipped)
  - Pylint score: 10.00/10 for py_fade, 9.97/10 for tests
- **Expanded LM Eval Support**: Enhanced support for lm-evaluation-harness results with split subsets
  - Multiple samples files per results file now supported (e.g., MMLU with per-subset samples)
  - Improved model ID extraction from paths (extracts clean name from `/workspace/model-name`)
  - Full prompt text extraction with chat template token stripping (Gemma3, Qwen3, Llama3, Mistral)
  - Added template stripping functions: `strip_template_gemma3()`, `strip_template_qwen3()`, `strip_template_llama3()`, `strip_template_mistral()`
  - Auto-detection of template type from model ID or content markers via `strip_chat_template()`
  - Paired filtering correctly identifies regressions in tuned models vs base models
  - Comprehensive test coverage with 10 new unit tests for MMLU data and template stripping
  - All tests passing with zero failures
- **Sample Tags**: Implemented complete sample tagging functionality
  - Created many-to-many relationship between samples and tags via SampleTag association table
  - Added helper methods to Sample model: add_tag(), remove_tag(), get_tags(), has_tag()
  - Added helper methods to Tag model: get_samples(), update_sample_count()
  - Created modal dialog (SampleTagsDialog) for selecting tags to add/remove from samples
  - Added tags display and edit button to sample widget control panel
  - Implemented "Samples by Tag" navigation view in sidebar
  - Tags grouped hierarchically with samples organized by group_path under each tag
  - "No Tag" node for samples without any tags
  - Search filtering works across tags and samples
  - Comprehensive test coverage with 37 new unit tests (16 database, 21 UI)
  - All tests passing with zero failures
  - Pylint score: 10.00/10 for both py_fade and tests packages
- **Export Wizard Model Selection**: Added model selection step to export wizard for explicit target model choice
  - New model selection step in export wizard between template selection and output path
  - Model combobox populated with all available model IDs from providers manager
  - ExportController now accepts target_model_id parameter for logprobs validation
  - Export wizard passes selected model_id to export controller
  - Falls back to first available model if no model is explicitly selected
  - Export templates remain model-agnostic for reusability across model variants
  - Comprehensive test coverage with 9 new unit tests for model selection feature
  - Updated all existing export wizard tests to handle new step
- **Encrypted Export/Import**: Added AES-encrypted ZIP export/import functionality
  - Export templates can now encrypt exported datasets with a password using pyzipper library
  - Import wizard supports automatic detection and decryption of encrypted ZIP files
  - Plaintext data never touches disk when encryption is enabled
  - Password can be pre-configured in export template or prompted during export/import
  - Updated UI text to clarify encryption uses "encrypted ZIP" instead of SQLCipher
  - Comprehensive test coverage with 8 new unit tests for encrypted export/import

### Fixed
- **New Completion Frame Save Bug Fixes**: Fixed three critical bugs in the new completion frame save functionality
  - Bug 1: Manual mode now correctly saves edited text instead of reverting to original generated text
  - Bug 2: Token-by-token mode now properly saves accumulated tokens when save button is clicked
  - Bug 3: Token picker area expanded to 2x width of completion area for better visibility in token-by-token mode
  - Comprehensive test coverage with 2 new tests verifying all bug fixes

### Added
- **Role Tag Buttons Moved to Controls Panel**: Relocated system/user/assistant role tag buttons from prompt area to controls panel
  - Buttons (S, U, A) now appear in the controls panel on the right side of the sample widget
  - Maintains all existing functionality including keyboard shortcuts and insertion behavior
  - Better UI organization by grouping all controls together
  - Updated tests to verify new location while preserving functionality tests
  - Comprehensive test coverage with 2 new location verification tests
- **Facet Summary Report**: Added comprehensive facet summary report feature for tracking training readiness
  - Added `min_rating`, `min_logprob_threshold`, and `avg_logprob_threshold` fields to Facet model
  - Added UI controls in WidgetFacet for editing threshold values
  - New "Facet Summary" button in dataset context frame (enabled when facet and model are selected)
  - FacetSummaryController analyzes samples for SFT and DPO training readiness
  - Modal window displays statistics for finished/unfinished samples
  - Shows total loss calculations and detailed reasons for unfinished samples
  - For SFT: requires completion with rating >= min_rating and passing logprob thresholds
  - For DPO: requires high-rated completion plus at least one lower-rated completion
  - Comprehensive test coverage with 15 new unit tests and 5 UI tests
- **Beam Out from Heatmap**: Added ability to start beam search from any token position in heatmap mode
  - Click on any token in heatmap view to see alternatives for that position
  - Token picker shows up to 200 alternatives in multi-select mode
  - Automatically extracts prefix (all tokens before clicked position) as prefill
  - Starts beam generation with selected alternatives at clicked position
  - Maintains token fidelity by working with actual tokens rather than text
  - beam_token property is set on generated completions
  - Comprehensive test coverage with 8 new tests
- **Extended New Completion Widget**: Enhanced the new completion widget with four generation modes and comprehensive UI improvements
  - **Mode Selector**: Switch between Regular, Continue Truncated, Manual Input, and Token-by-Token generation modes
  - **Regular Mode**: Generate completions from prompt with optional prefill (existing behavior)
  - **Continuation Mode**: Continue truncated completions with high-fidelity token sequence preservation
  - **Manual Mode**: Manually input completion text with custom model ID for cloud provider completions
  - **Token-by-Token Mode**: Interactive token selection with real-time token picker showing next token candidates
    - Displays up to 100 token candidates sorted by logprob with color-coded probabilities
    - Manual token selection builds completion prefix step-by-step
    - "Continue" button allows switching from token-by-token to regular generation mid-sequence
  - Icon buttons with readable labels (Generate, Continue, Save) for clarity
  - Adaptive UI that shows/hides controls based on selected mode
  - Comprehensive test coverage with 16 new tests covering all modes and edge cases
- **Prompt Role Tag Insert**: Added UI controls for inserting multi-turn conversation role tags in prompts
  - Right-click context menu in prompt editor with options to insert system/user/assistant tags at cursor or end
  - Three buttons (S, U, A) in prompt control panel for quick tag insertion at end of prompt
  - System tag validation: only one system tag allowed and must be at beginning of prompt
  - User and assistant tags can be inserted multiple times at any position
  - Tags use flat prefix template format (`<|system|>`, `<|user|>`, `<|assistant|>`)
  - Comprehensive test coverage with 26 new tests for PlainTextEdit and WidgetSample
- **Beam search: truncated Completion continuation**: Both transient and persisted completions in beam search window now show continuation button if truncated. For persistent completions, the same 3-way editor flow is used as in WidgetSample. For transient completions, continuation is generated in place without additional user input, keeping current context size and replacing the completion frame with the expanded completion.

### Fixed
- **Multi-line and Emoji Highlighting Bug**: Fixed highlighting issues with multi-line text and emoji/multi-byte Unicode characters in completion text editor
  - Fixed multi-line prefill and beam token highlighting by replacing Qt's `document.find()` (which doesn't support newlines) with manual string search
  - Replaced Python string indexing with Qt's QTextCursor positioning for correct UTF-16 code unit handling
  - Fixed prefill, beam token, and heatmap highlighting to properly handle surrogate pairs, newlines, and multi-line text
  - Added comprehensive test coverage for multi-line and emoji highlighting scenarios
- **Beam Completion Widget Update Bug**: Fixed issue where CompletionFrame in beam search window was not updated after saving a beam
  - Modified `WidgetSample.add_completion()` to return the created `PromptCompletion`
  - Updated `WidgetCompletionBeams.on_beam_accepted()` to update frame with persisted completion
  - Frame now correctly shows saved state (archive button visible, save/pin buttons hidden)
  - Model info header now becomes visible for saved beams
  - Added 3 comprehensive unit tests to verify fix
- **Emoji Highlighting Bug**: Fixed highlighting issues with emoji and multi-byte Unicode characters in completion text editor
  - Replaced Python string indexing with Qt's UTF-16-aware text positioning methods
  - Fixed prefill, beam token, and heatmap highlighting to properly handle surrogate pairs
  - All text positioning now uses `QTextDocument.find()` and `QTextCursor` for correct UTF-16 code unit handling
  - Added comprehensive test coverage for emoji highlighting scenarios
- **Prompt Editor Rich Text Bug**: Fixed issue where prompt editor allowed rich markup from copy-paste operations. The prompt editor now enforces plain text only while preserving programmed formatting markers (flat prefix templates).
  - Created `PlainTextEdit` component that extends `QTextEdit` with plain text enforcement
  - Replaced `QTextEdit` with `PlainTextEdit` in `WidgetSample` prompt area
  - Added comprehensive tests for rich text rejection and plain text enforcement

### Added
- `PlainTextEdit` widget component for plain text only editing with rich text rejection
- **Samples By Facet Navigation**: Added new navigation view to browse samples grouped by their associated facets
  - Root nodes are facets with "No Facet" node for unassociated samples
  - Samples are organized hierarchically under each facet by their group path
  - Samples can appear under multiple facets if rated for multiple facets
  - Search filter works across facet names, descriptions, sample titles, and group paths
  - Added `Facet.get_samples()` and `Facet.get_samples_without_facet()` methods
  - Comprehensive test coverage with 9 new tests
- **Improved Logprob Coloring**: Enhanced visual distinction for token probability heatmaps with new Dark Green → Orange → Red → Purple spectrum
  - 18 precisely specified color thresholds for better visual discrimination
  - Clear distinction between high probabilities (p=0.95 vs p=0.9) and tail probabilities (-20 vs -25)
  - Smooth linear interpolation between all threshold points
  - Maintains full backwards compatibility with existing code
- **Rating Removal**: Added ability to remove completion ratings for facets
  - Clicking on an already-rated star now shows a dialog with options to remove the rating, change it, or cancel
  - New `_remove_rating()` method handles deletion and UI state reset
  - UI properly updates to unrated state after removal (stars reset, tooltips update)
  - Comprehensive test coverage for removal, cancellation, and change options

## Version 0.0.1 (to be released)

- Initial public release of pyFADE.
- Major: ⭐ **Per-facet completion ratings** – Completions now include a five-star control with half-star support for fine-grained quality ratings. Ratings are foundation for preparing and exporting datasets for actual fine-tuning.
- Major: ⭐ **Facet Backup** – Complete import/export functionality for facets with all associated data (samples, completions, ratings). Supports JSON-based backup format with version control, merge strategies, and round-trip consistency validation.
- Major: **Dataset database encryption** using SQLCipher with `sqlcipher3` package.
- Minor: Option to encrypt/decrypt/change password of dataset databases.
- Minor: CRUD UI for Tags, Facets, and Export Templates in the dataset workspace.
- QA: Basic unit tests for various parts of the GUI.
- QA: Comprehensive test coverage for Facet Backup functionality (36 tests covering serialization, import, export, and full-cycle workflows).
